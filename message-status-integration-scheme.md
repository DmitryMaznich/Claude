# üì± –°—Ö–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π —Å Telegram Bot API

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Browser   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   Backend    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  Telegram Bot   ‚îÇ
‚îÇ  (Frontend) ‚îÇ  HTTP   ‚îÇ   Server     ‚îÇ  HTTPS  ‚îÇ      API        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò Polling ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò Webhook ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                2 sec          ‚îÇ                         ‚îÇ
                               ‚îÇ                         ‚îÇ
                               ‚ñº                         ‚ñº
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ   Database   ‚îÇ         ‚îÇ  Telegram Chat  ‚îÇ
                        ‚îÇ  (Messages)  ‚îÇ         ‚îÇ  with Operator  ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä –°—Ç–∞—Ç—É—Å—ã —Å–æ–æ–±—â–µ–Ω–∏–π

### Lifecycle —Å–æ–æ–±—â–µ–Ω–∏—è:

```
1. SENDING     ‚è≥ (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç)
2. SENT        ‚úì  (–ø–æ–ª—É—á–µ–Ω–æ –±—ç–∫–µ–Ω–¥–æ–º)
3. DELIVERED   ‚úì‚úì (–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ Telegram –æ–ø–µ—Ä–∞—Ç–æ—Ä—É)
4. READ        ‚úì‚úì (–ø—Ä–æ—á–∏—Ç–∞–Ω–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º) - —Å–∏–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏
```

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - Message Schema:

```javascript
{
  messageId: "uuid-v4",              // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è
  sessionId: "session-uuid",         // ID —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  content: "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
  sender: "user" | "bot" | "operator",
  timestamp: "2024-02-13T10:30:00Z",

  // –°—Ç–∞—Ç—É—Å—ã
  status: "sending" | "sent" | "delivered" | "read",
  statusTimestamps: {
    sent: "2024-02-13T10:30:00Z",
    delivered: "2024-02-13T10:30:05Z",
    read: "2024-02-13T10:30:15Z"
  },

  // Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
  telegramMessageId: 12345,          // ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
  telegramChatId: -1001234567890,    // ID —á–∞—Ç–∞ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  isOperatorMode: false,
  attachments: []
}
```

---

## üîå API Endpoints (Backend)

### 1. **POST /api/chat** - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
```javascript
// Request
{
  sessionId: "uuid",
  message: "–¢–µ–∫—Å—Ç",
  operatorMode: false
}

// Response
{
  messageId: "uuid",           // ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
  status: "sent",              // –ù–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
  response: "–û—Ç–≤–µ—Ç –±–æ—Ç–∞",
  operatorMode: false
}
```

### 2. **GET /api/messages/:sessionId** - Polling –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
```javascript
// Request
GET /api/messages/uuid-session?lastMessageTime=2024-02-13T10:30:00Z

// Response
{
  messages: [
    {
      messageId: "uuid",
      content: "–¢–µ–∫—Å—Ç",
      sender: "operator",
      timestamp: "2024-02-13T10:30:05Z"
    }
  ],

  // –°—Ç–∞—Ç—É—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  statusUpdates: [
    {
      messageId: "uuid-user-message",
      status: "delivered",
      timestamp: "2024-02-13T10:30:05Z"
    },
    {
      messageId: "uuid-user-message-2",
      status: "read",
      timestamp: "2024-02-13T10:30:15Z"
    }
  ],

  operatorMode: true
}
```

### 3. **POST /api/webhook/telegram** - Webhook –æ—Ç Telegram
```javascript
// Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç update –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö
{
  update_id: 123456,
  message: {
    message_id: 12345,
    from: { id: 987654321, username: "operator" },
    chat: { id: -1001234567890 },
    date: 1707825600,
    text: "–û—Ç–≤–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"
  }
}

// –ò–õ–ò –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ø—Ä–æ—á–∏—Ç–∞–Ω–æ"
{
  update_id: 123457,
  message_reaction: {
    chat: { id: -1001234567890 },
    message_id: 12345,
    date: 1707825615,
    old_reaction: [],
    new_reaction: [{ type: "emoji", emoji: "üëÄ" }]
  }
}
```

---

## ü§ñ Telegram Bot API Integration

### –ú–µ—Ç–æ–¥—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

#### 1. **sendMessage** - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
```javascript
POST https://api.telegram.org/bot<TOKEN>/sendMessage
{
  chat_id: -1001234567890,  // ID –≥—Ä—É–ø–ø—ã/—á–∞—Ç–∞ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
  text: "–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n–¢–µ–∫—Å—Ç...",
  reply_markup: {
    inline_keyboard: [[
      { text: "‚úì –ü—Ä–æ—á–∏—Ç–∞–Ω–æ", callback_data: "read_uuid-message" }
    ]]
  }
}

// Response
{
  ok: true,
  result: {
    message_id: 12345,  // –í–ê–ñ–ù–û: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    date: 1707825600
  }
}
```

#### 2. **getUpdates** –∏–ª–∏ **setWebhook** - –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

**–í–∞—Ä–∏–∞–Ω—Ç A: Polling (–ø—Ä–æ—â–µ –¥–ª—è –Ω–∞—á–∞–ª–∞)**
```javascript
GET https://api.telegram.org/bot<TOKEN>/getUpdates
?offset=<last_update_id+1>
&timeout=30  // Long polling

// –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
```

**–í–∞—Ä–∏–∞–Ω—Ç B: Webhook (production-ready)**
```javascript
POST https://api.telegram.org/bot<TOKEN>/setWebhook
{
  url: "https://smartwash.si/api/webhook/telegram",
  allowed_updates: ["message", "callback_query", "message_reaction"]
}
```

#### 3. **answerCallbackQuery** - –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"
```javascript
POST https://api.telegram.org/bot<TOKEN>/answerCallbackQuery
{
  callback_query_id: "query_id",
  text: "–û—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ ‚úì"
}
```

---

## üîÑ –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤

### Backend Logic (Node.js/Python –ø—Ä–∏–º–µ—Ä):

```javascript
// 1. –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
async function sendToTelegram(message, sessionId) {
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
  const telegramResponse = await fetch(
    `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: OPERATOR_CHAT_ID,
        text: `[${sessionId}]\n${message}`,
        reply_markup: {
          inline_keyboard: [[
            { text: "‚úì –ü—Ä–æ—á–∏—Ç–∞–Ω–æ", callback_data: `read_${messageId}` }
          ]]
        }
      })
    }
  );

  const data = await telegramResponse.json();

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –∏–∑ Telegram
  await db.updateMessage(messageId, {
    telegramMessageId: data.result.message_id,
    status: 'delivered',  // –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ Telegram
    'statusTimestamps.delivered': new Date()
  });

  return data.result.message_id;
}

// 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç Telegram
async function handleTelegramWebhook(update) {
  // Callback –æ—Ç –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"
  if (update.callback_query) {
    const callbackData = update.callback_query.data;

    if (callbackData.startsWith('read_')) {
      const messageId = callbackData.replace('read_', '');

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–ø—Ä–æ—á–∏—Ç–∞–Ω–æ"
      await db.updateMessage(messageId, {
        status: 'read',
        'statusTimestamps.read': new Date()
      });

      // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏
      await answerCallbackQuery(update.callback_query.id);
    }
  }

  // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  if (update.message && update.message.text) {
    const operatorMessage = update.message.text;

    // –ò–∑–≤–ª–µ–∫–∞–µ–º sessionId –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const sessionMatch = operatorMessage.match(/\[([\w-]+)\]/);

    if (sessionMatch) {
      const sessionId = sessionMatch[1];

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
      await db.createMessage({
        sessionId,
        content: operatorMessage,
        sender: 'operator',
        timestamp: new Date(),
        status: 'sent'
      });

      // –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∏—Ç —ç—Ç–æ —á–µ—Ä–µ–∑ polling
    }
  }
}

// 3. Polling endpoint - –æ—Ç–¥–∞—ë–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
async function getMessages(sessionId, lastMessageTime) {
  // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  const messages = await db.getMessages({
    sessionId,
    timestamp: { $gt: lastMessageTime }
  });

  // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
  const statusUpdates = await db.getStatusUpdates({
    sessionId,
    'statusTimestamps.delivered': { $gt: lastMessageTime }
  });

  return {
    messages,
    statusUpdates: statusUpdates.map(msg => ({
      messageId: msg.messageId,
      status: msg.status,
      timestamp: msg.statusTimestamps[msg.status]
    }))
  };
}
```

---

## üé® Frontend Implementation

### 1. HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å—Ç–∞—Ç—É—Å–æ–º:

```html
<div class="chat-message user" data-message-id="uuid">
  <div class="message-bubble">
    –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    <span class="message-status">
      <span class="status-icon sending">‚è≥</span>
    </span>
  </div>
</div>
```

### 2. CSS —Å—Ç–∏–ª–∏:

```css
.message-status {
  display: inline-block;
  margin-left: 6px;
  font-size: 0.85em;
}

.status-icon {
  transition: all 0.3s ease;
}

.status-icon.sending {
  color: #999;
}

.status-icon.sent {
  color: #999;
}

.status-icon.delivered {
  color: #4ade80;
}

.status-icon.read {
  color: #34b7f1;
}
```

### 3. JavaScript –ª–æ–≥–∏–∫–∞:

```javascript
// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage() {
  const message = chatInput.value.trim();
  if (!message) return;

  // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID
  const tempMessageId = 'temp_' + Date.now();

  // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "sending"
  const messageElement = addMessage(message, 'user', tempMessageId);
  updateMessageStatus(tempMessageId, 'sending');

  chatInput.value = '';

  try {
    const response = await fetch(`${API_URL}/api/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sessionId: SESSION_ID,
        message,
        operatorMode: chatMode === 'live'
      })
    });

    const data = await response.json();

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
    messageElement.dataset.messageId = data.messageId;
    updateMessageStatus(data.messageId, 'sent');

    // –ß–µ—Ä–µ–∑ 1-2 —Å–µ–∫—É–Ω–¥—ã —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ polling

  } catch (error) {
    updateMessageStatus(tempMessageId, 'error');
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
function updateMessageStatus(messageId, status) {
  const messageElement = document.querySelector(
    `[data-message-id="${messageId}"]`
  );

  if (!messageElement) return;

  const statusIcon = messageElement.querySelector('.status-icon');
  if (!statusIcon) return;

  // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã
  statusIcon.className = 'status-icon ' + status;

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é –∏–∫–æ–Ω–∫—É
  switch(status) {
    case 'sending':
      statusIcon.textContent = '‚è≥';
      break;
    case 'sent':
      statusIcon.textContent = '‚úì';
      break;
    case 'delivered':
      statusIcon.textContent = '‚úì‚úì';
      break;
    case 'read':
      statusIcon.textContent = '‚úì‚úì';
      statusIcon.style.color = '#34b7f1';
      break;
    case 'error':
      statusIcon.textContent = '‚úï';
      statusIcon.style.color = '#ff4444';
      break;
  }
}

// –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π polling - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã
async function startPolling() {
  if (pollingInterval) return;

  pollingInterval = setInterval(async () => {
    if (isPolling) return;
    isPolling = true;

    try {
      const response = await fetch(
        `${API_URL}/api/messages/${SESSION_ID}?lastMessageTime=${lastMessageTime}`
      );
      const data = await response.json();

      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      if (data.messages && data.messages.length > 0) {
        data.messages.forEach(msg => {
          addMessage(msg.content, msg.sender);
        });

        lastMessageTime = data.messages[data.messages.length - 1].timestamp;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      if (data.statusUpdates && data.statusUpdates.length > 0) {
        data.statusUpdates.forEach(update => {
          updateMessageStatus(update.messageId, update.status);
        });
      }

    } catch (error) {
      console.error('Polling error:', error);
    } finally {
      isPolling = false;
    }
  }, 2000);
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. **Telegram Bot Token:**
```javascript
// –•—Ä–∞–Ω–∏—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
process.env.TELEGRAM_BOT_TOKEN

// –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—å –≤ git!
```

### 2. **Webhook verification:**
```javascript
// –ü—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—à—ë–ª –æ—Ç Telegram
function verifyTelegramWebhook(req) {
  const token = req.headers['x-telegram-bot-api-secret-token'];
  return token === process.env.TELEGRAM_WEBHOOK_SECRET;
}
```

### 3. **Rate limiting:**
```javascript
// –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Telegram API
// Max 30 messages per second
```

---

## üìà –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Phase 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (MVP)
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `messageId` –≤ —Å–æ–æ–±—â–µ–Ω–∏—è
2. ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—Ç—å `telegramMessageId` –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å "delivered" –∫–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram
4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

### Phase 2: Telegram Webhook
1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook endpoint
2. ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å callback_query –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å inline –∫–Ω–æ–ø–∫–∏ –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º –≤ Telegram
4. ‚úÖ –û–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å "read" –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏

### Phase 3: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ–∏—á–∏
1. ‚≠ê –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ "–ø—Ä–æ—á–∏—Ç–∞–Ω–æ" —á–µ—Ä–µ–∑ Telegram API
2. ‚≠ê –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –≤–ª–æ–∂–µ–Ω–∏–π (—Ñ–æ—Ç–æ)
3. ‚≠ê –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
4. ‚≠ê Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket –≤–º–µ—Å—Ç–æ polling

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Test Cases:

```javascript
// 1. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
Test: –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã
Expected: sending ‚Üí sent ‚Üí delivered

// 2. –û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"
Test: –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
Expected: delivered ‚Üí read (—Å–∏–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏)

// 3. –ü–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
Test: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ "sending"
Expected: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ –∏–ª–∏ retry

// 4. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
Test: –°—Ç–∞—Ç—É—Å—ã –Ω–µ –ø—É—Ç–∞—é—Ç—Å—è –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
Expected: –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–º–µ–µ—Ç —Å–≤–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å
```

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

```
User sends "–ü—Ä–∏–≤–µ—Ç" ‚Üí
  Frontend:
    - Creates temp message with ‚è≥
    - Sends to backend

  Backend:
    - Saves to DB with status "sent" ‚úì
    - Sends to Telegram API
    - Gets telegramMessageId: 12345
    - Updates DB: status "delivered" ‚úì‚úì

  Telegram:
    - Operator sees message with button [‚úì –ü—Ä–æ—á–∏—Ç–∞–Ω–æ]
    - Operator clicks button

  Backend Webhook:
    - Receives callback_query
    - Updates DB: status "read" ‚úì‚úì (blue)

  Frontend Polling:
    - Gets statusUpdate: { messageId, status: "read" }
    - Updates UI: ‚úì‚úì turns blue
```

---

## üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Environment Variables (.env):

```bash
# Telegram Bot
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_OPERATOR_CHAT_ID=-1001234567890
TELEGRAM_WEBHOOK_SECRET=your-secret-token-here

# Backend
API_URL=https://claude-production-e0ea.up.railway.app
PORT=3000

# Database
DATABASE_URL=postgresql://user:pass@host:5432/smartwash
```

### Telegram Bot Setup:

```bash
# 1. –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather
/newbot
# –ü–æ–ª—É—á–∏—Ç—å token

# 2. –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
# –°–¥–µ–ª–∞—Ç—å –µ–≥–æ –∞–¥–º–∏–Ω–æ–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è message_id

# 3. –ü–æ–ª—É—á–∏—Ç—å chat_id –≥—Ä—É–ø–ø—ã
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
curl https://api.telegram.org/bot<TOKEN>/getUpdates

# 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook (production)
curl -X POST https://api.telegram.org/bot<TOKEN>/setWebhook \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://smartwash.si/api/webhook/telegram",
    "allowed_updates": ["message", "callback_query"]
  }'
```

---

## üöÄ Ready to implement!

–≠—Ç–∞ —Å—Ö–µ–º–∞ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π —Å Telegram Bot API.
